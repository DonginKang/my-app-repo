# ci-pipeline.yaml íŒŒì¼

# ... (name: ê³¼ on: ë¶€ë¶„ì€ ê·¸ëŒ€ë¡œ ë‘¡ë‹ˆë‹¤)

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
    - name: 1. Checkout App Repository
      uses: actions/checkout@v4

    - name: 2. Login to GitHub Container Registry (GHCR)
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    # 3ë‹¨ê³„: ì†Œë¬¸ìë¡œ ë³€í™˜ëœ ì´ë¯¸ì§€ íƒœê·¸ ìƒì„±
    - name: 3. Generate Lowercase Image Tag
      id: image-tag # ì´ ë‹¨ê³„ì˜ ì¶œë ¥ì„ ì°¸ì¡°í•˜ê¸° ìœ„í•œ ID
      run: |
        # github.repository_ownerë¥¼ ì†Œë¬¸ìë¡œ ë³€í™˜í•˜ì—¬ ì „ì²´ ì´ë¯¸ì§€ íƒœê·¸ë¥¼ ìƒì„±í•˜ê³ ,
        # ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ GITHUB_OUTPUTì— ì €ì¥í•©ë‹ˆë‹¤.
        echo "TAG=ghcr.io/${{ toLower(github.repository_owner) }}/${{ github.event.repository.name }}:${{ github.sha }}" >> $GITHUB_OUTPUT

    # 4ë‹¨ê³„: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° GHCRë¡œ í‘¸ì‹œ
    - name: 4. Build and Push Docker Image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        # ì´ì „ ë‹¨ê³„(id: image-tag)ì—ì„œ ìƒì„±í•œ íƒœê·¸ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
        tags: ${{ steps.image-tag.outputs.TAG }}

    # 5ë‹¨ê³„: ì„¤ì •ì„ ë‹´ì€ my-config-repo ì²´í¬ì•„ì›ƒ
    - name: 5. Checkout Config Repository
      uses: actions/checkout@v4
      with:
        repository: <ë‚´ GitHub ID>/my-config-repo # ğŸ‘ˆ ì´ ë¶€ë¶„ì€ ìì‹ ì˜ config-repo ì£¼ì†Œë¡œ ìœ ì§€
        token: ${{ secrets.PAT }}

    # 6ë‹¨ê³„: ì¿ ë²„ë„¤í‹°ìŠ¤ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ì˜ ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸
    - name: 6. Update Kubernetes Manifest
      run: |
        # ì´ì „ ë‹¨ê³„ì—ì„œ ìƒì„±í•œ ë™ì¼í•œ íƒœê·¸ë¥¼ ì‚¬ìš©í•˜ì—¬ deployment.yaml íŒŒì¼ì„ ìˆ˜ì •í•©ë‹ˆë‹¤.
        sed -i "s|image:.*|image: ${{ steps.image-tag.outputs.TAG }}|g" deployment.yaml
        
    # 7ë‹¨ê³„: ë³€ê²½ëœ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ë¥¼ config-repoì— ì»¤ë°‹ ë° í‘¸ì‹œ
    - name: 7. Commit and Push to Config Repository
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        git add deployment.yaml
        git commit -m "Update image to ${{ github.sha }}"
        git push
