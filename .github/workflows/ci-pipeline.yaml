# ì›Œí¬í”Œë¡œìš°ì˜ ì „ì²´ ì´ë¦„
name: CI-CD Pipeline for My App

# ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹¤í–‰ì‹œí‚¤ëŠ” ì¡°ê±´(íŠ¸ë¦¬ê±°)
on:
  # 'main' ë¸Œëœì¹˜ì— 'push' ì´ë²¤íŠ¸ê°€ ë°œìƒí–ˆì„ ë•Œ ì‹¤í–‰
  push:
    branches: [ main ]

# ì‹¤ì œ ìˆ˜í–‰ë  ì‘ì—…ë“¤ì˜ ë¬¶ìŒ
jobs:
  build-and-deploy:
    # ì‘ì—…ì´ ì‹¤í–‰ë  ê°€ìƒ ì„œë²„ í™˜ê²½
    runs-on: ubuntu-latest
    # ì´ ì‘ì—…ì— í•„ìš”í•œ ê¶Œí•œ ì„¤ì •
    permissions:
      contents: write # config-repoì— ì»¤ë°‹í•˜ê¸° ìœ„í•œ ê¶Œí•œ
      packages: write # GHCRì— ì´ë¯¸ì§€ë¥¼ í‘¸ì‹œí•˜ê¸° ìœ„í•œ ê¶Œí•œ

    # ì‘ì—…ì˜ ë‹¨ê³„ë³„ ì‹¤í–‰ ìˆœì„œ
    steps:
    # 1ë‹¨ê³„: ì• í”Œë¦¬ì¼€ì´ì…˜ ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
    - name: 1. Checkout App Repository
      uses: actions/checkout@v4

    # 2ë‹¨ê³„: GitHub Container Registry(GHCR)ì— ë¡œê·¸ì¸
    - name: 2. Login to GitHub Container Registry (GHCR)
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    # 3ë‹¨ê³„: ì´ë¯¸ì§€ ì´ë¦„ ë° íƒœê·¸ ìƒì„± (ì†Œë¬¸ì ë³€í™˜)
    - name: 3. Generate Image Info
      id: image-info # ì´ ë‹¨ê³„ì˜ ì¶œë ¥ì„ ì°¸ì¡°í•˜ê¸° ìœ„í•œ ID
      run: |
        # github.repository ê°’ì„ ëª¨ë‘ ì†Œë¬¸ìë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
        IMAGE_NAME=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
        echo "IMAGE_NAME=${IMAGE_NAME}" >> $GITHUB_OUTPUT
        echo "IMAGE_TAG=${{ github.sha }}" >> $GITHUB_OUTPUT

    # 4ë‹¨ê³„: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° GHCRë¡œ í‘¸ì‹œ
    - name: 4. Build and Push Docker Image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ghcr.io/${{ steps.image-info.outputs.IMAGE_NAME }}:${{ steps.image-info.outputs.IMAGE_TAG }}

    # 5ë‹¨ê³„: ì„¤ì •ì„ ë‹´ì€ my-config-repo ì²´í¬ì•„ì›ƒ
    - name: 5. Checkout Config Repository
      uses: actions/checkout@v4
      with:
        repository: <ë‚´ GitHub ID>/my-config-repo # ğŸ‘ˆ ì´ ë¶€ë¶„ì€ ìì‹ ì˜ config-repo ì£¼ì†Œë¡œ ë³€ê²½
        token: ${{ secrets.PAT }}

    # 6ë‹¨ê³„: ì¿ ë²„ë„¤í‹°ìŠ¤ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ì˜ ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸
    - name: 6. Update Kubernetes Manifest
      run: |
        sed -i "s|image:.*|image: ghcr.io/${{ steps.image-info.outputs.IMAGE_NAME }}:${{ steps.image-info.outputs.IMAGE_TAG }}|g" deployment.yaml
        
    # 7ë‹¨ê³„: ë³€ê²½ëœ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ë¥¼ config-repoì— ì»¤ë°‹ ë° í‘¸ì‹œ
    - name: 7. Commit and Push to Config Repository
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        git add deployment.yaml
        git commit -m "Update image to ${{ steps.image-info.outputs.IMAGE_TAG }}"
        git push
